<!-- src/app/admin/users/admin-users.component.html -->
<div class="users-page page-content">
  <div class="header-grid container">
    <div>
      <h1 class="page-title">User Management</h1>
      <p class="muted">Manage all customers, technicians and admins</p>
    </div>

    <div class="actions">
      <div class="tabs">
        <button
          *ngFor="let t of tabs"
          (click)="setTab(t.key)"
          [class.active]="activeRole === t.key"
          class="tab-btn">
          {{ t.label }}
        </button>
      </div>

      <div class="search-row">
        <input
          type="search"
          [(ngModel)]="q"
          (keyup.enter)="onSearchKey($event)"
          placeholder="Search by name, email..."
          class="search-input" />
        <button class="search-go" (click)="onSearchKey()">
          Search
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div *ngIf="loading" class="loading">Loading users...</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <div *ngIf="!loading && !error">
      <div *ngIf="users.length === 0" class="empty">No users found.</div>

      <div class="users-grid">
        <div class="user-card" *ngFor="let u of users" (click)="openDetails(u)">
          <div class="card-top">
            <div class="avatar">
              <img
                *ngIf="u.profileImage"
                [src]="u.profileImage"
                class="avatar-img" />
              <span *ngIf="!u.profileImage">
                {{ u.fullName.slice(0, 1) }}
              </span>
            </div>

            <div class="meta">
              <h3 class="name">{{ u.fullName }}</h3>
              <div class="sub">{{ u.email }}</div>
            </div>
            <div class="role-pill">{{ u.role }}</div>
          </div>

          <div class="card-body">
            <div class="row">
              <div class="label">Status</div>
              <div class="value">{{ u.status || '-' }}</div>
            </div>
            <div class="row">
              <div class="label">Joined</div>
              <div class="value">{{ fmt(u.createdAt) }}</div>
            </div>

            <ng-container *ngIf="u.role === 'Customer' || u.role === 'Technician'">
              <div class="row">
                <div class="label">Phone</div>
                <div class="value">{{ u.phone || '-' }}</div>
              </div>
              <div class="row address-row" *ngIf="u.address">
                <div class="label">Address</div>
                <div class="value address-value">{{ u.address }}</div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <div class="pager">
        <button (click)="prevPage()" [disabled]="page <= 1">Prev</button>
        <div>Page {{ page }} • {{ total }} users</div>
        <button (click)="nextPage()" [disabled]="page * pageSize >= total">
          Next
        </button>
      </div>
    </div>
  </div>

  <!-- Details Drawer -->
  <div class="drawer" [class.open]="drawerOpen">
    <div class="drawer-inner">
      <button class="drawer-close" (click)="closeDrawer()">✕</button>

      <div *ngIf="detailLoading" class="detail-loading">Loading...</div>

      <div *ngIf="!detailLoading && selectedUser" class="detail-content">
        <div class="detail-header">
          <div class="avatar-large">
            <img
              *ngIf="selectedUser.profileImage"
              [src]="selectedUser.profileImage"
              class="avatar-large-img" />
            <span *ngIf="!selectedUser.profileImage">
              {{ selectedUser.fullName.slice(0, 1) }}
            </span>
          </div>
          <div>
            <h2>{{ selectedUser.fullName }}</h2>
            <div class="muted">{{ selectedUser.email }}</div>
            <div class="muted">Role: {{ selectedUser.role }}</div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Profile</h4>
          <div class="field">
            <strong>Phone:</strong> {{ selectedUser.phone || '-' }}
          </div>
          <div class="field">
            <strong>Address:</strong> {{ selectedUser.address || '-' }}
          </div>
          <div class="field">
            <strong>Status:</strong> {{ selectedUser.status || '-' }}
          </div>
          <div class="field">
            <strong>Joined:</strong> {{ fmt(selectedUser.createdAt) }}
          </div>
          <div class="field">
            <strong>Email verified:</strong>
            {{ selectedUser.emailConfirmed ? 'Yes' : 'No' }}
          </div>
        </div>

        <!-- Technician info & verification -->
        <div *ngIf="selectedUser.technician as tech" class="detail-section">
          <h4>Technician Info</h4>

          <div class="field">
            <strong>Verification:</strong>
            {{ tech.verificationStatus }}
          </div>

          <div class="field">
            <strong>Experience:</strong>
            {{ tech.experienceYears ?? '-' }} yrs
          </div>

          <div class="field">
            <strong>Rating:</strong>
            {{ tech.ratingAverage ?? '-' }}
          </div>

          <!-- DOCUMENT LINKS -->
          <div
            class="field"
            *ngIf="$any(tech).idProof || $any(tech).certificate">
            <strong>Documents:</strong>
            <span>
              <!-- ID Proof -->
              <a *ngIf="$any(tech).idProof"
                [href]="getDocUrl($any(tech).idProof)"
                target="_blank">
                View ID Proof
              </a>

              <span *ngIf="$any(tech).idProof && $any(tech).certificate">
                &nbsp;|&nbsp;
              </span>

              <!-- Certificate -->
              <a
                *ngIf="$any(tech).certificate"
                [href]="getDocUrl($any(tech).certificate)"
                target="_blank">
                View Certificate
              </a>
            </span>
          </div>

          <!-- Approve / Reject actions -->
          <div *ngIf="technicianSelected" class="tech-actions">
            <div *ngIf="techActionMsg" class="tech-msg">
              {{ techActionMsg }}
            </div>

            <textarea
              [(ngModel)]="rejectReason"
              rows="3"
              placeholder="Reject reason (optional)"></textarea>

            <div class="btn-row">
              <button
                class="btn approve"
                (click)="approveTechnician()
                "
                [disabled]="techActionLoading || !technicianHasDocs">
                Approve
              </button>

              <button
                class="btn reject"
                (click)="rejectTechnician()"
                [disabled]="techActionLoading">
                Reject
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="selectedUser.admin" class="detail-section">
          <h4>Admin Info</h4>
          <div class="field">
            <strong>Level:</strong> {{ selectedUser.admin.adminLevel }}
          </div>
          <div class="field">
            <strong>Can manage users:</strong>
            {{ selectedUser.admin.canManageUsers ? 'Yes' : 'No' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>